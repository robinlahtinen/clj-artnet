name: Vulnerability scan

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]
    schedule:
        -   cron: "37 23 * * 4"

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read

jobs:
    vulnerability-scan:
        name: Run clj-watson scanning
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write
            actions: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v6

            -   name: Prepare Java
                uses: actions/setup-java@v5
                with:
                    distribution: "oracle"
                    java-version: "25"

            -   name: Install Clojure tools
                uses: DeLaGuardo/setup-clojure@13.5.2
                with:
                    cli: latest

            -   name: Cache Clojure dependencies
                uses: actions/cache@v5
                with:
                    path: |
                        ~/.m2/repository
                        ~/.gitlibs
                        ~/.deps.clj
                    key: cljdeps-${{ hashFiles('deps.edn') }}
                    restore-keys: cljdeps-

            -   name: Dependency scan
                id: watson-scan
                continue-on-error: true
                run: |
                    clojure -Sdeps '{:deps {io.github.clj-holmes/clj-watson {:git/tag "v6.0.1" :git/sha "b520351"}}}' \
                      -M -m clj-watson.cli scan \
                      -p deps.edn \
                      -a test -a build \
                      -t github-advisory \
                      -s \
                      -o sarif 1> clj-watson-results.sarif || true
                    # Check if output is valid JSON, if not clear it
                    if [ -f clj-watson-results.sarif ] && ! head -c 1 clj-watson-results.sarif | grep -q '{'; then
                      echo "SARIF output is not valid JSON:"
                      cat clj-watson-results.sarif
                      rm -f clj-watson-results.sarif
                    fi
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            -   name: Upload analysis results to GitHub
                uses: github/codeql-action/upload-sarif@v4
                if: always() && hashFiles('clj-watson-results.sarif') != ''
                with:
                    sarif_file: ${{ github.workspace }}/clj-watson-results.sarif
                    wait-for-processing: true

            -   name: Fail if vulnerabilities found
                if: steps.watson-scan.outcome == 'failure'
                run: exit 1
