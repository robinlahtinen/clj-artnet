name: Deploy documentation to GitHub Pages

on:
    push:
        branches: [ "main" ]
    workflow_dispatch:

permissions:
    contents: read
    pages: write
    id-token: write

concurrency:
    group: "pages"
    cancel-in-progress: false

jobs:
    build-and-deploy:
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v6

            -   name: Prepare Java
                uses: actions/setup-java@v5
                with:
                    distribution: "oracle"
                    java-version: "25"

            -   name: Install Clojure tools
                uses: DeLaGuardo/setup-clojure@13.4
                with:
                    cli: latest

            -   name: Cache Clojure dependencies
                uses: actions/cache@v5
                with:
                    path: |
                        ~/.m2/repository
                        ~/.gitlibs
                        ~/.deps.clj
                    key: cljdeps-${{ hashFiles('deps.edn') }}
                    restore-keys: cljdeps-

            -   name: Generate API documentation
                run: clojure -X:docs

            -   name: Setup GitHub Pages
                uses: actions/configure-pages@v5

            -   name: Upload artifact
                uses: actions/upload-pages-artifact@v4
                with:
                    path: "target/docs"

            -   name: Deploy to GitHub Pages
                id: deployment
                uses: actions/deploy-pages@v4
